#!/usr/bin/env bash

die() {
  printf '%s\n' "$*" >&2
  exit 1
}

if [ $# -gt 1 ] || [ $# = 1 -a "$1" != "debug" ]; then \
    echo Usage: "$0 [debug]"; exit 1; \
fi

clang-format --version >/dev/null || \
  die "clang-format not found; please install clang-format to use this script"

npm ci --prefix webgl

if [ $# -eq 1 ]; then
  NPM_SCRIPT_TARGET=build-debug-nosourcemap
  JS_FORMATTER=clang-format
  JS_FORMATTER_OPTS=--style=file:"webgl/.clang-format"
else
  NPM_SCRIPT_TARGET=build
  JS_FORMATTER=cat
  JS_FORMATTER_OPTS=
fi

ASYGL_OUTPUT_FROM_WEBPACK=webgl/dist/gl.js
test -f "$ASYGL_OUTPUT_FROM_WEBPACK" || die "Missing $ASYGL_OUTPUT_FROM_WEBPACK"

npm run "$NPM_SCRIPT_TARGET" --prefix webgl

ASYGL_OUTPUT=base/webgl/asygl.js
{
  cat webgl/license;
  echo "/* license for gl-matrix: ";
  curl -L https://cdn.jsdelivr.net/gh/toji/gl-matrix@refs/heads/master/LICENSE.md;
  echo "*/";
  "$JS_FORMATTER" $JS_FORMATTER_OPTS "$ASYGL_OUTPUT_FROM_WEBPACK";
} > "$ASYGL_OUTPUT"
